name: Destroy Step 3 - RDS Force Destroy (Production Safe)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  DB_IDENTIFIER: ${{ vars.DB_IDENTIFIER }}

jobs:
  rds_force_destroy:
    name: Force Destroy RDS (No Dependency, No Error)
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      # ----------------------------
      # 1. AWS Auth
      # ----------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      # ----------------------------
      # 2. Disable deletion protection (CRITICAL)
      # ----------------------------
      - name: Disable RDS deletion protection
        run: |
          aws rds modify-db-instance \
            --db-instance-identifier $DB_IDENTIFIER \
            --no-deletion-protection \
            --apply-immediately || true

      # ----------------------------
      # 3. Force delete RDS (skip final snapshot)
      # ----------------------------
      - name: Force delete RDS instance (skip snapshot)
        run: |
          aws rds delete-db-instance \
            --db-instance-identifier $DB_IDENTIFIER \
            --skip-final-snapshot || true

      # ----------------------------
      # 4. Wait until RDS is fully gone
      # ----------------------------
      - name: Wait for RDS deletion
        run: |
          echo "Waiting for RDS instance to be fully deleted..."
          aws rds wait db-instance-deleted \
            --db-instance-identifier $DB_IDENTIFIER || true

      # ----------------------------
      # 5. (Optional) Clean Terraform state if exists
      # ----------------------------
      - name: Best-effort Terraform cleanup (ignore failures)
        if: ${{ always() }}
        run: |
          cd terraform/rds || exit 0
          terraform init -input=false || true
          terraform destroy -auto-approve -input=false || true
