name: Destroy Step 2 - EKS Terraform Destroy (Auto SG Cleanup)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  CLUSTER_NAME: ${{ vars.CLUSTER_NAME }}

jobs:
  eks_destroy:
    name: Terraform Destroy - EKS (Auto Dependency Cleanup)
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      # ----------------------------
      # 1. Checkout
      # ----------------------------
      - name: Checkout code
        uses: actions/checkout@v5

      # ----------------------------
      # 2. AWS Auth
      # ----------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      # ----------------------------
      # 3. Auto remove RDS -> EKS SG dependency (CRITICAL)
      # ----------------------------
      - name: Remove RDS inbound rules referencing EKS node SG
        run: |
          echo "Finding EKS node security group..."

          NODE_SG_ID=$(aws ec2 describe-security-groups \
            --filters Name=group-name,Values="*node*" \
            --query "SecurityGroups[0].GroupId" \
            --output text)

          echo "EKS Node SG: $NODE_SG_ID"

          echo "Finding all security groups referencing this SG..."

          SG_IDS=$(aws ec2 describe-security-groups \
            --query "SecurityGroups[?IpPermissions[?UserIdGroupPairs[?GroupId=='$NODE_SG_ID']]].GroupId" \
            --output text)

          for SG in $SG_IDS; do
            echo "Processing SG: $SG"

            RULES=$(aws ec2 describe-security-groups \
              --group-ids $SG \
              --query "SecurityGroups[0].IpPermissions[?UserIdGroupPairs[?GroupId=='$NODE_SG_ID']]" \
              --output json)

            aws ec2 revoke-security-group-ingress \
              --group-id $SG \
              --ip-permissions "$RULES" || true

            echo "Removed dependency from SG: $SG"
          done

      # ----------------------------
      # 4. Setup Terraform
      # ----------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # ----------------------------
      # 5. Terraform Init
      # ----------------------------
      - name: Terraform Init (EKS)
        working-directory: terraform/eks
        run: |
          terraform init -input=false

      # ----------------------------
      # 6. Terraform Destroy
      # ----------------------------
      - name: Terraform Destroy (EKS)
        working-directory: terraform/eks
        run: |
          terraform destroy -auto-approve -input=false
