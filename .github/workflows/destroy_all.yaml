name: Destroy - Full AWS Cleanup (One Click)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  DB_IDENTIFIER: caltrans-eks-php-mysql

jobs:

  # ==========================================
  # 1Ô∏è‚É£ CLEAN K8S
  # ==========================================
  k8s_cleanup:
    name: Cleanup Kubernetes
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - run: aws eks update-kubeconfig --region $AWS_REGION --name ${{ vars.CLUSTER_NAME }}

      - run: kubectl delete namespace ${{ vars.K8S_NAMESPACE }} --ignore-not-found


  # ==========================================
  # 2Ô∏è‚É£ FORCE DELETE RDS (AWS ONLY)
  # ==========================================
  force_delete_rds:
    name: Force Delete RDS (AWS)
    runs-on: ubuntu-latest
    needs: k8s_cleanup
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Disable deletion protection
        run: |
          aws rds modify-db-instance \
            --db-instance-identifier $DB_IDENTIFIER \
            --no-deletion-protection \
            --apply-immediately || true

      - name: Wait for available
        run: |
          aws rds wait db-instance-available \
            --db-instance-identifier $DB_IDENTIFIER || true

      - name: Force delete RDS
        run: |
          aws rds delete-db-instance \
            --db-instance-identifier $DB_IDENTIFIER \
            --skip-final-snapshot \
            --delete-automated-backups || true

      - name: Wait for deletion
        run: |
          aws rds wait db-instance-deleted \
            --db-instance-identifier $DB_IDENTIFIER || true


  # ==========================================
  # 3Ô∏è‚É£ CLEAN RDS FROM STATE
  # ==========================================
  cleanup_rds_state:
    name: Cleanup RDS State
    runs-on: ubuntu-latest
    needs: force_delete_rds
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3

      - run: terraform init -input=false
        working-directory: terraform/rds

      - run: |
          terraform state rm aws_db_instance.mysql || true
          terraform state rm aws_db_subnet_group.this || true
          terraform state rm aws_security_group.rds_sg || true
        working-directory: terraform/rds


  # ==========================================
  # 4Ô∏è‚É£ DESTROY EKS
  # ==========================================
  destroy_eks:
    name: Destroy EKS
    runs-on: ubuntu-latest
    needs: cleanup_rds_state
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3
      - run: terraform init -input=false
        working-directory: terraform/eks
      - run: terraform destroy -auto-approve
        working-directory: terraform/eks


  # ==========================================
  # 5Ô∏è‚É£ DESTROY VPC
  # ==========================================
  destroy_vpc:
    name: Destroy VPC
    runs-on: ubuntu-latest
    needs: destroy_eks
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3
      - run: terraform init -input=false
        working-directory: terraform/vpc
      - run: terraform destroy -auto-approve
        working-directory: terraform/vpc


  # ==========================================
  # 6Ô∏è‚É£ DESTROY BOOTSTRAP
  # ==========================================
  destroy_bootstrap:
    name: Destroy Bootstrap
    runs-on: ubuntu-latest
    needs: destroy_vpc
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3
      - run: terraform init -input=false
        working-directory: terraform/bootstrap
      - run: terraform destroy -auto-approve
        working-directory: terraform/bootstrap


  # ==========================================
  # 7Ô∏è‚É£ DONE
  # ==========================================
  done:
    name: Done
    runs-on: ubuntu-latest
    needs: destroy_bootstrap

    steps:
      - run: echo "üî• Full AWS environment destroyed successfully."
