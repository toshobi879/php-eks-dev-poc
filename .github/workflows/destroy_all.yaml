name: Destroy - Full AWS Cleanup (One Click)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  DB_IDENTIFIER: caltrans-eks-php-mysql

jobs:

  # ==========================================
  # 1Ô∏è‚É£ CLEAN K8S
  # ==========================================
  k8s_cleanup:
    name: Cleanup Kubernetes
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - run: aws eks update-kubeconfig --region $AWS_REGION --name ${{ vars.CLUSTER_NAME }}

      - run: kubectl delete namespace ${{ vars.K8S_NAMESPACE }} --ignore-not-found


  # ==========================================
  # 4Ô∏è‚É£ DESTROY EKS
  # ==========================================
  destroy_eks:
    name: Destroy EKS
    runs-on: ubuntu-latest
    needs: cleanup_rds_state
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3
      - run: terraform init -input=false
        working-directory: terraform/eks
      - run: terraform destroy -auto-approve
        working-directory: terraform/eks


  # ==========================================
  # 5Ô∏è‚É£ DESTROY VPC
  # ==========================================
  destroy_vpc:
    name: Destroy VPC
    runs-on: ubuntu-latest
    needs: destroy_eks
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3
      - run: terraform init -input=false
        working-directory: terraform/vpc
      - run: terraform destroy -auto-approve
        working-directory: terraform/vpc


  # ==========================================
  # 6Ô∏è‚É£ DESTROY BOOTSTRAP
  # ==========================================
  destroy_bootstrap:
    name: Destroy Bootstrap
    runs-on: ubuntu-latest
    needs: destroy_vpc
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3
      - run: terraform init -input=false
        working-directory: terraform/bootstrap
      - run: terraform destroy -auto-approve
        working-directory: terraform/bootstrap


  # ==========================================
  # 7Ô∏è‚É£ DONE
  # ==========================================
  done:
    name: Done
    runs-on: ubuntu-latest
    needs: destroy_bootstrap

    steps:
      - run: echo "üî• Full AWS environment destroyed successfully."
