name: Destroy Step 5 - ECR Cleanup (Only office-locator)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}

jobs:
  ecr_destroy:
    name: Delete ONLY ECR repo - office-locator
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      # 1. AWS Auth
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      # 2. Safety check - print repo name
      - name: Show target ECR repository
        run: |
          echo "Target ECR repository to delete: $ECR_REPOSITORY"

      # 3. Delete all images from ONLY this repo
      - name: Delete all images from office-locator repo
        run: |
          IMAGE_IDS=$(aws ecr list-images \
            --repository-name "$ECR_REPOSITORY" \
            --query 'imageIds[*]' \
            --output json)

          if [ "$IMAGE_IDS" != "[]" ]; then
            echo "Deleting images from $ECR_REPOSITORY ..."
            aws ecr batch-delete-image \
              --repository-name "$ECR_REPOSITORY" \
              --image-ids "$IMAGE_IDS"
          else
            echo "No images found in $ECR_REPOSITORY"
          fi

      # 4. Delete ONLY this repository
      - name: Delete ONLY office-locator repository
        run: |
          aws ecr delete-repository \
            --repository-name "$ECR_REPOSITORY" \
            --force
