name: Full Destroy - Infra + App (One Click)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:

  # ==========================================
  # 1️⃣ DELETE KUBERNETES RESOURCES
  # ==========================================
  k8s-cleanup:
    name: Cleanup Kubernetes Resources
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CLUSTER_NAME: ${{ vars.CLUSTER_NAME }}
      NAMESPACE: ${{ vars.K8S_NAMESPACE }}

    steps:
      - uses: actions/checkout@v5

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $CLUSTER_NAME

      - name: Delete Kubernetes resources
        run: |
          kubectl delete svc --all -n $NAMESPACE --ignore-not-found
          kubectl delete deploy --all -n $NAMESPACE --ignore-not-found
          kubectl delete job --all -n $NAMESPACE --ignore-not-found
          kubectl delete cm --all -n $NAMESPACE --ignore-not-found
          kubectl delete secret --all -n $NAMESPACE --ignore-not-found
          kubectl delete ingress --all -n $NAMESPACE --ignore-not-found

      - name: Wait for LoadBalancers to delete
        run: |
          echo "Waiting 90 seconds for ELB cleanup..."
          sleep 90

  # ==========================================
  # 2️⃣ DESTROY RDS
  # ==========================================
  destroy-rds:
    name: Terraform Destroy - RDS
    runs-on: ubuntu-latest
    needs: k8s-cleanup
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init & Destroy (RDS)
        working-directory: terraform/rds
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
        run: |
          terraform init -input=false
          terraform destroy -auto-approve -input=false

  # ==========================================
  # 3️⃣ DESTROY EKS
  # ==========================================
  destroy-eks:
    name: Terraform Destroy - EKS
    runs-on: ubuntu-latest
    needs: destroy-rds
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init & Destroy (EKS)
        working-directory: terraform/eks
        run: |
          terraform init -input=false
          terraform destroy -auto-approve -input=false

  # ==========================================
  # 4️⃣ DESTROY VPC
  # ==========================================
  destroy-vpc:
    name: Terraform Destroy - VPC
    runs-on: ubuntu-latest
    needs: destroy-eks
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v5

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init & Destroy (VPC)
        working-directory: terraform/vpc
        run: |
          terraform init -input=false
          terraform destroy -auto-approve -input=false
